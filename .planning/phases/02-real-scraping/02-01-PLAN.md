---
phase: 02-real-scraping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/scrapers/__init__.py
  - tests/scrapers/test_smart_scraper.py
autonomous: true

must_haves:
  truths:
    - "SmartScraper site kesfedebiliyor (sitemap, menu, AI)"
    - "SmartScraper birden fazla sayfayi paralel tarayabiliyor"
    - "SmartScraper hatalari duzgun yonetiyor"
    - "Testler mock ile API cagrisiz calisabiliyor"
  artifacts:
    - path: "tests/scrapers/__init__.py"
      provides: "Test paketi tanimlamasi"
    - path: "tests/scrapers/test_smart_scraper.py"
      provides: "SmartScraper unit testleri"
      min_lines: 150
  key_links:
    - from: "tests/scrapers/test_smart_scraper.py"
      to: "src/sade_agents/scrapers/smart_scraper.py"
      via: "import SmartScraper"
      pattern: "from sade_agents.scrapers.smart_scraper import"
---

<objective>
SmartScraper icin kapsamli unit testler olustur.

Purpose: SmartScraper'in site kesfi (sitemap, menu, AI), paralel tarama ve hata yonetimi ozelliklerini dogrulayan testler yazmak.

Output: `tests/scrapers/test_smart_scraper.py` dosyasi ile calisan test suite.
</objective>

<execution_context>
@C:\Users\Hp\.claude/agents/gsd-planner.md
@C:\Users\Hp\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Test edilecek kod
@src/sade_agents/scrapers/smart_scraper.py
@src/sade_agents/scrapers/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test Paketi Olustur</name>
  <files>tests/scrapers/__init__.py</files>
  <action>
Test paketi olustur:
- `tests/scrapers/__init__.py` dosyasi olustur
- Bos `__all__` listesi tanimla
- Docstring ekle: "Sade Agents - Scraper test paketi"
  </action>
  <verify>`python -c "import tests.scrapers"` hata vermeden calisir</verify>
  <done>Test paketi import edilebilir durumda</done>
</task>

<task type="auto">
  <name>Task 2: SmartScraper Unit Testleri</name>
  <files>tests/scrapers/test_smart_scraper.py</files>
  <action>
SmartScraper icin unit testler yaz. pytest + pytest-asyncio kullan.

**Gerekli importlar:**
```python
import pytest
from unittest.mock import AsyncMock, MagicMock, patch
from sade_agents.scrapers.smart_scraper import (
    SmartScraper, DiscoveredPage, SiteDiscoveryResult, smart_scrape_all
)
from sade_agents.scrapers.ai_scraper import ScrapingTarget
from sade_agents.scrapers.base import ProductPrice, ScraperResult
```

**Test siniflari:**

1. `TestSmartScraperInit`:
   - `test_init_creates_ai_scraper`: AIScraper instance olusturulur
   - `test_init_clears_visited_urls`: visited_urls set bos baslar

2. `TestSiteDiscovery`:
   - `test_discover_from_sitemap`: Sitemap bulundugunda dogru URL'ler doner
   - `test_discover_from_menu`: Menu'den urun sayfalari bulunur
   - `test_discover_with_ai`: AI kesif calisir (OpenAI mock)
   - `test_discovery_priority`: Sitemap > Menu > AI sirasi dogru

3. `TestUrlFiltering`:
   - `test_should_skip_url_cart`: /cart URL'leri atlanir
   - `test_should_skip_url_login`: /login URL'leri atlanir
   - `test_should_not_skip_product_url`: /products URL'leri atlanmaz
   - `test_guess_page_type_product`: /shop, /urunler dogru tiplendirilir

4. `TestScraping`:
   - `test_scrape_site_success`: Basarili tarama urunleri doner
   - `test_scrape_site_empty_discovery`: Kesif bossa ana sayfa taranir
   - `test_scrape_site_parallel`: Birden fazla sayfa paralel taranir
   - `test_scrape_site_handles_errors`: Tek sayfa hatasi tum taramayi bozmaz

5. `TestDeduplication`:
   - `test_deduplicate_products_by_name`: Ayni isimli urunler tekrar etmez
   - `test_deduplicate_case_insensitive`: Buyuk/kucuk harf farki yok sayilir

6. `TestSmartScrapeAll`:
   - `test_smart_scrape_all_no_targets`: Hedef yoksa uyari doner
   - `test_smart_scrape_all_with_targets`: Hedefler taranir, dict doner

**Mock stratejisi:**
- `aiohttp.ClientSession` mock'la (network cagrilari yok)
- `OpenAI` client mock'la (API cagrilari yok)
- `AIScraper.scrape` mock'la (izole test)

**Fixtures:**
```python
@pytest.fixture
def mock_html_with_products():
    return """
    <html><body>
    <nav><a href="/cikolata">Cikolatalar</a><a href="/truffle">Truffle</a></nav>
    <div class="product">Bitter 100g - 450 TL</div>
    </body></html>
    """

@pytest.fixture
def mock_sitemap_xml():
    return """
    <?xml version="1.0"?>
    <urlset>
      <url><loc>https://example.com/cikolata</loc></url>
      <url><loc>https://example.com/truffle</loc></url>
    </urlset>
    """

@pytest.fixture
def sample_target():
    return ScrapingTarget(
        name="test_site",
        url="https://example.com",
        description="test cikolata",
    )
```

**Dikkat:**
- Her test async fonksiyon olacak (`async def test_...`)
- `@pytest.mark.asyncio` decorator kullan
- Mock'larda `AsyncMock` kullan network islemleri icin
  </action>
  <verify>
`pytest tests/scrapers/test_smart_scraper.py -v` komutu ile tum testler gecer.
En az 15 test olmali.
  </verify>
  <done>SmartScraper unit testleri yazildi ve tumu geciyor</done>
</task>

<task type="auto">
  <name>Task 3: Test Calistir ve Dogrula</name>
  <files>-</files>
  <action>
Testleri calistir ve sonuclari dogrula:

1. Tum scraper testlerini calistir:
   ```bash
   pytest tests/scrapers/ -v --tb=short
   ```

2. Coverage kontrol et (opsiyonel):
   ```bash
   pytest tests/scrapers/ --cov=sade_agents.scrapers.smart_scraper --cov-report=term-missing
   ```

3. Hata varsa duzelt, tekrar calistir.
  </action>
  <verify>
`pytest tests/scrapers/ -v` komutu 0 exit code ile biter.
Tum testler PASSED durumunda.
  </verify>
  <done>SmartScraper testleri basariyla gecti</done>
</task>

</tasks>

<verification>
- [ ] `tests/scrapers/__init__.py` dosyasi mevcut
- [ ] `tests/scrapers/test_smart_scraper.py` dosyasi mevcut
- [ ] En az 15 unit test yazildi
- [ ] Tum testler gecti (`pytest` 0 exit code)
- [ ] Testler mock kullanarak network/API cagrisi yapmiyor
</verification>

<success_criteria>
SmartScraper'in tum temel fonksiyonlari icin unit testler yazilmis ve gecmis durumda. Testler izole ve deterministik (mock kullaniyor).
</success_criteria>

<output>
Tamamlandiginda `.planning/phases/02-real-scraping/02-01-SUMMARY.md` olustur.
</output>
