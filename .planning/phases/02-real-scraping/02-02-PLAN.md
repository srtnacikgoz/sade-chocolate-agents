---
phase: 02-real-scraping
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/scrapers/test_ai_scraper.py
  - tests/scrapers/test_target_loading.py
autonomous: true

must_haves:
  truths:
    - "AIScraper HTML'den urun cikarabiliyor"
    - "AIScraper hatalari duzgun yonetiyor"
    - "load_targets_from_file dogru calisiyor"
    - "load_targets_from_config oncelik sirasina uyuyor"
  artifacts:
    - path: "tests/scrapers/test_ai_scraper.py"
      provides: "AIScraper unit testleri"
      min_lines: 100
    - path: "tests/scrapers/test_target_loading.py"
      provides: "Target yukleme testleri"
      min_lines: 60
  key_links:
    - from: "tests/scrapers/test_ai_scraper.py"
      to: "src/sade_agents/scrapers/ai_scraper.py"
      via: "import AIScraper"
      pattern: "from sade_agents.scrapers.ai_scraper import"
---

<objective>
AIScraper ve target yukleme fonksiyonlari icin unit testler olustur.

Purpose: AIScraper'in HTML parsing, AI extraction ve hata yonetimi; target yukleme fonksiyonlarinin (file, firebase, config) dogru calistigini dogrulamak.

Output: `tests/scrapers/test_ai_scraper.py` ve `tests/scrapers/test_target_loading.py` dosyalari.
</objective>

<execution_context>
@C:\Users\Hp\.claude/agents/gsd-planner.md
@C:\Users\Hp\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Test edilecek kod
@src/sade_agents/scrapers/ai_scraper.py
@src/sade_agents/scrapers/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: AIScraper Unit Testleri</name>
  <files>tests/scrapers/test_ai_scraper.py</files>
  <action>
AIScraper icin unit testler yaz. pytest + pytest-asyncio kullan.

**Gerekli importlar:**
```python
import pytest
import json
from unittest.mock import AsyncMock, MagicMock, patch
from sade_agents.scrapers.ai_scraper import (
    AIScraper, ScrapingTarget, scrape_all_with_ai
)
from sade_agents.scrapers.base import ProductPrice, ScraperResult
```

**Test siniflari:**

1. `TestAIScraperInit`:
   - `test_init_creates_openai_client`: OpenAI client olusturulur
   - `test_init_uses_settings`: Settings'den API key alinir

2. `TestHtmlCleaning`:
   - `test_clean_html_removes_scripts`: Script taglari temizlenir
   - `test_clean_html_removes_nav`: Nav/footer taglari temizlenir
   - `test_clean_html_truncates_long`: Uzun HTML kirpilir (max_chars)
   - `test_clean_html_returns_body_text`: Sadece body text doner

3. `TestProductExtraction`:
   - `test_extract_products_parses_json`: LLM JSON response'u parse edilir
   - `test_extract_products_handles_markdown_json`: ```json wrapper temizlenir
   - `test_extract_products_handles_empty`: Bos array doner (urun yok)
   - `test_extract_products_handles_invalid_json`: JSONDecodeError yonetilir
   - `test_extract_products_skips_invalid_items`: Gecersiz itemlar atlanir

4. `TestScraping`:
   - `test_scrape_success`: Basarili tarama ScraperResult doner
   - `test_scrape_network_error`: Network hatasi error message'a yazilir
   - `test_scrape_api_error`: OpenAI API hatasi yonetilir

5. `TestScrapeAllWithAI`:
   - `test_scrape_all_no_targets`: Hedef yoksa warning doner
   - `test_scrape_all_with_targets`: Tum hedefler taranir
   - `test_scrape_all_handles_exceptions`: Tek hata diger tarmalari etkilemez

**Mock stratejisi:**
- `aiohttp.ClientSession` mock'la (network yok)
- `OpenAI.chat.completions.create` mock'la (API yok)

**Fixtures:**
```python
@pytest.fixture
def mock_openai_response():
    mock = MagicMock()
    mock.choices = [MagicMock()]
    mock.choices[0].message.content = json.dumps([
        {"name": "Bitter 100g", "price_tl": 450, "weight_grams": 100, "category": "tablet"},
        {"name": "Truffle Kutu", "price_tl": 890, "weight_grams": None, "category": "truffle"},
    ])
    return mock

@pytest.fixture
def sample_html():
    return """
    <html>
    <head><script>var x = 1;</script></head>
    <body>
    <nav>Menu</nav>
    <div class="products">
        <div>Bitter Cikolata 100g - 450 TL</div>
        <div>Truffle Kutusu - 890 TL</div>
    </div>
    <footer>Footer</footer>
    </body>
    </html>
    """

@pytest.fixture
def sample_target():
    return ScrapingTarget(
        name="test_shop",
        url="https://test.com/products",
        description="cikolata",
    )
```
  </action>
  <verify>
`pytest tests/scrapers/test_ai_scraper.py -v` komutu ile tum testler gecer.
En az 12 test olmali.
  </verify>
  <done>AIScraper unit testleri yazildi ve tumu geciyor</done>
</task>

<task type="auto">
  <name>Task 2: Target Loading Testleri</name>
  <files>tests/scrapers/test_target_loading.py</files>
  <action>
Target yukleme fonksiyonlari icin unit testler yaz.

**Test siniflari:**

1. `TestLoadTargetsFromFile`:
   - `test_load_from_file_success`: JSON dosyasi okunur, ScrapingTarget listesi doner
   - `test_load_from_file_not_found`: Dosya yoksa bos liste doner
   - `test_load_from_file_invalid_json`: Gecersiz JSON bos liste doner
   - `test_load_from_file_empty_targets`: targets: [] bos liste doner

2. `TestLoadTargetsFromFirebase`:
   - `test_load_from_firebase_not_configured`: Firebase yoksa bos liste doner
   - `test_load_from_firebase_success`: Firebase'den aktif hedefler yuklenir
   - `test_load_from_firebase_filters_inactive`: active: false olanlar atlanir

3. `TestLoadTargetsFromConfig`:
   - `test_config_prefers_firebase`: Firebase varsa oradan yukler
   - `test_config_falls_back_to_file`: Firebase bossa dosyadan yukler
   - `test_config_returns_empty_if_none`: Hicbiri yoksa bos liste

**Mock stratejisi:**
- `Path.exists` mock'la (dosya simulasyonu)
- `open` mock'la (dosya icerigi simulasyonu)
- `firebase_admin` mock'la (Firebase simulasyonu)
- `get_settings` mock'la (config simulasyonu)

**Fixtures:**
```python
@pytest.fixture
def valid_targets_json():
    return json.dumps({
        "targets": [
            {"name": "vakko", "url": "https://vakko.com", "description": "vakko"},
            {"name": "kahve", "url": "https://kahve.com", "description": "kahve"},
        ]
    })

@pytest.fixture
def mock_settings():
    settings = MagicMock()
    settings.scraping_targets_file = "scraping_targets.json"
    settings.is_firebase_configured.return_value = False
    return settings
```
  </action>
  <verify>
`pytest tests/scrapers/test_target_loading.py -v` komutu ile tum testler gecer.
En az 8 test olmali.
  </verify>
  <done>Target loading testleri yazildi ve tumu geciyor</done>
</task>

<task type="auto">
  <name>Task 3: Tum Testleri Calistir</name>
  <files>-</files>
  <action>
Tum scraper testlerini calistir:

```bash
pytest tests/scrapers/ -v --tb=short
```

Hata varsa duzelt, tekrar calistir.
  </action>
  <verify>
`pytest tests/scrapers/ -v` komutu 0 exit code ile biter.
Tum testler (en az 35 test) PASSED durumunda.
  </verify>
  <done>Tum AIScraper ve target loading testleri basariyla gecti</done>
</task>

</tasks>

<verification>
- [ ] `tests/scrapers/test_ai_scraper.py` dosyasi mevcut
- [ ] `tests/scrapers/test_target_loading.py` dosyasi mevcut
- [ ] AIScraper icin en az 12 test yazildi
- [ ] Target loading icin en az 8 test yazildi
- [ ] Tum testler gecti
</verification>

<success_criteria>
AIScraper ve target yukleme fonksiyonlari icin unit testler yazilmis ve gecmis durumda. Testler izole ve deterministik.
</success_criteria>

<output>
Tamamlandiginda `.planning/phases/02-real-scraping/02-02-SUMMARY.md` olustur.
</output>
