---
phase: 08-orkestrasyon
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - scripts/run_crews.py
autonomous: false

must_haves:
  truths:
    - "User can run ProductLaunchCrew from CLI"
    - "User can run MarketAnalysisCrew from CLI"
    - "User can run QualityAuditCrew from CLI"
    - "CLI supports dry-run mode for testing"
    - "CLI provides clear feedback during execution"
  artifacts:
    - path: "scripts/run_crews.py"
      provides: "CLI script to run crew workflows"
      min_lines: 150
  key_links:
    - from: "scripts/run_crews.py"
      to: "SadeCrewFactory"
      via: "factory import and usage"
      pattern: "from sade_agents.crews import SadeCrewFactory"
    - from: "scripts/run_crews.py"
      to: "workflow_models"
      via: "input validation"
      pattern: "ProductLaunchInput|MarketAnalysisInput|QualityAuditInput"
---

<objective>
Create CLI script to run crew workflows with proper UX feedback and dry-run support.

Purpose: Enable users to execute multi-agent workflows from command line, following existing run_* script patterns.
Output: run_crews.py with subcommands for each crew type, dry-run mode, and verbose feedback
</objective>

<execution_context>
@C:\Users\Hp\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Hp\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-orkestrasyon/08-RESEARCH.md
@.planning/phases/08-orkestrasyon/08-01-SUMMARY.md
@.planning/phases/08-orkestrasyon/08-02-SUMMARY.md

@scripts/run_narrator.py
@scripts/run_perfectionist.py
@src/sade_agents/crews/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create run_crews.py CLI script</name>
  <files>scripts/run_crews.py</files>
  <action>
Create `scripts/run_crews.py` following the existing run_* script patterns:

```python
#!/usr/bin/env python3
"""
Sade Chocolate - Crew Workflows CLI.

Multi-agent workflow'larini calistirir.

Kullanim:
    python scripts/run_crews.py product-launch --flavor "Ruby Cikolata"
    python scripts/run_crews.py market-analysis --competitor "Vakko"
    python scripts/run_crews.py quality-audit --content "Icerik metni"
    python scripts/run_crews.py --dry-run              # Sadece syntax kontrolu

Gereksinimler:
    - .env dosyasi (OPENAI_API_KEY ile)
"""

import argparse
import sys
import json
from pathlib import Path

# Proje root'unu Python path'e ekle
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root / "src"))


def check_api_key() -> bool:
    """API key'in mevcut olup olmadigini kontrol eder."""
    import os
    from dotenv import load_dotenv

    env_file = project_root / ".env"
    if env_file.exists():
        load_dotenv(env_file)

    api_key = os.getenv("OPENAI_API_KEY", "")
    return bool(api_key and api_key != "your-api-key-here")


def dry_run() -> None:
    """Syntax ve import kontrolu yapar (API cagrisi olmadan)."""
    print("Dry run: Import ve syntax kontrolu...")

    try:
        from sade_agents.crews import (
            SadeCrewFactory,
            ProductLaunchCrew,
            MarketAnalysisCrew,
            QualityAuditCrew,
        )
        from sade_agents.models import (
            ProductLaunchInput,
            ProductLaunchOutput,
            MarketAnalysisInput,
            MarketAnalysisOutput,
            QualityAuditInput,
            QualityAuditOutput,
        )

        print("  [OK] SadeCrewFactory import edildi")
        print("  [OK] Tum crew class'lari import edildi")
        print("  [OK] Tum workflow modelleri import edildi")

        # Factory test
        factory = SadeCrewFactory()
        print("  [OK] SadeCrewFactory olusturuldu")

        # Crew instantiation test
        for crew_type in ["product_launch", "market_analysis", "quality_audit"]:
            crew = factory.create_crew(crew_type)
            print(f"  [OK] {type(crew).__name__} olusturuldu")

        # API key kontrolu
        if check_api_key():
            print("  [OK] OPENAI_API_KEY mevcut")
        else:
            print("  [!] OPENAI_API_KEY eksik veya gecersiz")
            print("      -> .env.example'dan .env olusturun")

        print("\n[OK] Dry run basarili - tum importlar calisiyor")

    except ImportError as e:
        print(f"  [X] Import hatasi: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"  [X] Beklenmeyen hata: {e}")
        sys.exit(1)


def run_product_launch(args: argparse.Namespace) -> None:
    """ProductLaunchCrew calistirir."""
    print("Sade Chocolate - Product Launch Crew")
    print("=" * 50)

    if not check_api_key():
        print("\n[X] HATA: OPENAI_API_KEY gerekli!")
        sys.exit(1)

    from sade_agents.crews import SadeCrewFactory
    from sade_agents.models import ProductLaunchInput

    # Input hazirla
    inputs = {
        "flavor_concept": args.flavor,
        "target_audience": args.audience,
        "price_range": (args.price_min, args.price_max),
        "include_audit": not args.skip_audit,
    }

    print(f"\nGirdi:")
    print(f"  Lezzet: {inputs['flavor_concept']}")
    print(f"  Hedef Kitle: {inputs['target_audience']}")
    print(f"  Fiyat Araligi: {inputs['price_range'][0]}-{inputs['price_range'][1]} TL")
    print(f"  Denetim: {'Evet' if inputs['include_audit'] else 'Hayir'}")

    # Validate
    try:
        validated = ProductLaunchInput(**inputs)
        print("  [OK] Girdi dogrulandi")
    except Exception as e:
        print(f"  [X] Girdi hatasi: {e}")
        sys.exit(1)

    # Run crew
    print("\nCrew calistiriliyor...")
    print("-" * 50)

    factory = SadeCrewFactory()
    crew = factory.create_product_launch_crew()
    result = crew.kickoff(inputs)

    print("\n" + "=" * 50)
    print("[OK] Product Launch Crew Tamamlandi")
    print("=" * 50)
    print(f"\nCalisma suresi: {result.execution_time_seconds:.1f} saniye")
    print("\nSonuc:")
    print(json.dumps(result.model_dump(), indent=2, ensure_ascii=False, default=str))


def run_market_analysis(args: argparse.Namespace) -> None:
    """MarketAnalysisCrew calistirir."""
    print("Sade Chocolate - Market Analysis Crew")
    print("=" * 50)

    if not check_api_key():
        print("\n[X] HATA: OPENAI_API_KEY gerekli!")
        sys.exit(1)

    from sade_agents.crews import SadeCrewFactory
    from sade_agents.models import MarketAnalysisInput

    # Input hazirla
    inputs = {
        "competitor_name": args.competitor,
        "product_category": args.category,
        "include_trends": not args.skip_trends,
    }

    print(f"\nGirdi:")
    print(f"  Rakip: {inputs['competitor_name']}")
    print(f"  Kategori: {inputs['product_category']}")
    print(f"  Trend Analizi: {'Evet' if inputs['include_trends'] else 'Hayir'}")

    # Validate
    try:
        validated = MarketAnalysisInput(**inputs)
        print("  [OK] Girdi dogrulandi")
    except Exception as e:
        print(f"  [X] Girdi hatasi: {e}")
        sys.exit(1)

    # Run crew
    print("\nCrew calistiriliyor...")
    print("-" * 50)

    factory = SadeCrewFactory()
    crew = factory.create_market_analysis_crew()
    result = crew.kickoff(inputs)

    print("\n" + "=" * 50)
    print("[OK] Market Analysis Crew Tamamlandi")
    print("=" * 50)
    print(f"\nCalisma suresi: {result.execution_time_seconds:.1f} saniye")
    print("\nOzet:")
    print(result.summary)


def run_quality_audit(args: argparse.Namespace) -> None:
    """QualityAuditCrew calistirir."""
    print("Sade Chocolate - Quality Audit Crew")
    print("=" * 50)

    if not check_api_key():
        print("\n[X] HATA: OPENAI_API_KEY gerekli!")
        sys.exit(1)

    from sade_agents.crews import SadeCrewFactory
    from sade_agents.models import QualityAuditInput

    # Content'i al (arguman veya stdin)
    content = args.content
    if args.file:
        with open(args.file, "r", encoding="utf-8") as f:
            content = f.read()

    if not content:
        print("[X] HATA: --content veya --file gerekli!")
        sys.exit(1)

    # Input hazirla
    inputs = {
        "content": content,
        "content_type": args.content_type,
        "source_agent": args.source,
    }

    print(f"\nGirdi:")
    print(f"  Icerik Turu: {inputs['content_type']}")
    print(f"  Kaynak Agent: {inputs['source_agent']}")
    print(f"  Icerik Uzunlugu: {len(content)} karakter")

    # Validate
    try:
        validated = QualityAuditInput(**inputs)
        print("  [OK] Girdi dogrulandi")
    except Exception as e:
        print(f"  [X] Girdi hatasi: {e}")
        sys.exit(1)

    # Run crew
    print("\nCrew calistiriliyor...")
    print("-" * 50)

    factory = SadeCrewFactory()
    crew = factory.create_quality_audit_crew()
    result = crew.kickoff(inputs)

    print("\n" + "=" * 50)
    print("[OK] Quality Audit Crew Tamamlandi")
    print("=" * 50)
    print(f"\nCalisma suresi: {result.execution_time_seconds:.1f} saniye")
    print(f"\nSonuc: {'GECTI' if result.passed else 'KALDI'}")
    print(f"Puan: {result.audit_result.overall_score}/100")
    print(f"Karar: {result.audit_result.verdict}")
    if result.audit_result.issues:
        print("\nSorunlar:")
        for issue in result.audit_result.issues:
            print(f"  - {issue}")
    if result.audit_result.suggestions:
        print("\nOneriler:")
        for suggestion in result.audit_result.suggestions:
            print(f"  - {suggestion}")


def main() -> None:
    """Ana fonksiyon - CLI parser."""
    parser = argparse.ArgumentParser(
        description="Sade Chocolate - Crew Workflows CLI",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Ornekler:
  python scripts/run_crews.py --dry-run
  python scripts/run_crews.py product-launch --flavor "Antep Fistikli"
  python scripts/run_crews.py market-analysis --competitor "Vakko"
  python scripts/run_crews.py quality-audit --content "Test icerigi" --content-type metin --source narrator

Crew Tipleri:
  product-launch   : Alchemist -> Narrator -> Curator -> Perfectionist
  market-analysis  : PricingAnalyst -> GrowthHacker -> Narrator
  quality-audit    : Perfectionist (tek)
        """,
    )
    parser.add_argument(
        "--dry-run",
        action="store_true",
        help="Sadece import/syntax kontrolu yap",
    )

    subparsers = parser.add_subparsers(dest="command", help="Crew tipi")

    # Product Launch subcommand
    pl_parser = subparsers.add_parser("product-launch", help="Urun lansmani workflow'u")
    pl_parser.add_argument("--flavor", required=True, help="Lezzet konsepti (ornek: 'Ruby Cikolata')")
    pl_parser.add_argument("--audience", default="Quiet luxury consumers", help="Hedef kitle")
    pl_parser.add_argument("--price-min", type=float, default=100.0, help="Minimum fiyat (TL)")
    pl_parser.add_argument("--price-max", type=float, default=200.0, help="Maksimum fiyat (TL)")
    pl_parser.add_argument("--skip-audit", action="store_true", help="Perfectionist denetimini atla")

    # Market Analysis subcommand
    ma_parser = subparsers.add_parser("market-analysis", help="Pazar analizi workflow'u")
    ma_parser.add_argument("--competitor", required=True, help="Rakip adi (ornek: 'Vakko')")
    ma_parser.add_argument("--category", default="premium chocolate", help="Urun kategorisi")
    ma_parser.add_argument("--skip-trends", action="store_true", help="Trend analizini atla")

    # Quality Audit subcommand
    qa_parser = subparsers.add_parser("quality-audit", help="Kalite denetimi workflow'u")
    qa_parser.add_argument("--content", help="Denetlenecek icerik metni")
    qa_parser.add_argument("--file", help="Icerik dosyasi yolu")
    qa_parser.add_argument(
        "--content-type",
        choices=["metin", "gorsel_prompt", "fiyat_analizi", "trend_raporu", "recete"],
        default="metin",
        help="Icerik turu",
    )
    qa_parser.add_argument(
        "--source",
        choices=["narrator", "curator", "pricing", "growth", "alchemist"],
        default="narrator",
        help="Kaynak agent",
    )

    args = parser.parse_args()

    if args.dry_run:
        dry_run()
    elif args.command == "product-launch":
        run_product_launch(args)
    elif args.command == "market-analysis":
        run_market_analysis(args)
    elif args.command == "quality-audit":
        run_quality_audit(args)
    else:
        parser.print_help()
        print("\n[!] Bir crew tipi secin: product-launch, market-analysis, quality-audit")
        sys.exit(1)


if __name__ == "__main__":
    main()
```
  </action>
  <verify>
    python scripts/run_crews.py --dry-run
  </verify>
  <done>
    run_crews.py CLI script works with dry-run, shows all imports successful
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete orchestration layer with 3 crew compositions and CLI script</what-built>
  <how-to-verify>
1. Run dry-run to verify imports:
   ```
   python scripts/run_crews.py --dry-run
   ```
   Expected: All imports successful, factory creates crews

2. Check CLI help:
   ```
   python scripts/run_crews.py --help
   python scripts/run_crews.py product-launch --help
   ```
   Expected: Clear documentation of options

3. (Optional) If OPENAI_API_KEY available, test a quick audit:
   ```
   python scripts/run_crews.py quality-audit --content "Beklenmedik. Cikolatanin rengini degistirmek icin boyaya ihtiyaci yoktur." --content-type metin --source narrator
   ```
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Run verification commands:
```bash
# Dry run test
python scripts/run_crews.py --dry-run

# Help commands
python scripts/run_crews.py --help
python scripts/run_crews.py product-launch --help
python scripts/run_crews.py market-analysis --help
python scripts/run_crews.py quality-audit --help

# Import test
python -c "from sade_agents.crews import SadeCrewFactory; f = SadeCrewFactory(); print([type(f.create_crew(t)).__name__ for t in ['product_launch', 'market_analysis', 'quality_audit']])"
```
</verification>

<success_criteria>
- run_crews.py exists and is executable
- --dry-run mode works without API key
- All 3 subcommands (product-launch, market-analysis, quality-audit) are available
- CLI follows existing run_* script patterns (check_api_key, dry_run, etc.)
- Help text clearly documents usage
- User can successfully run crews via CLI
</success_criteria>

<output>
After completion, create `.planning/phases/08-orkestrasyon/08-03-SUMMARY.md`
</output>
